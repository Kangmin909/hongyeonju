{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///Users/kangmin/Desktop/project/hongyeonju/src/pages/api/getExhibition.js"],"sourcesContent":["import { Client } from \"@notionhq/client\";\n\nconst notion = new Client({ auth: process.env.NOTION_TOKEN });\n\nlet localCache = null;\nlet lastFetchTime = 0;\nconst CACHE_TTL = 1000 * 60 * 5; // 5분 (이미지 링크 만료 방지)\n\nexport default async function handler(req, res) {\n  const { force } = req.query;\n\n  if (force !== \"true\" && localCache && (Date.now() - lastFetchTime < CACHE_TTL)) {\n    res.setHeader(\"Cache-Control\", \"s-maxage=300, stale-while-revalidate=600\");\n    return res.status(200).json(localCache);\n  }\n\n  try {\n    const databaseId = process.env.NOTION_EXHIBITION_DB_ID;\n\n    const response = await notion.databases.query({\n      database_id: databaseId,\n    });\n\n    const data = await Promise.all(\n      response.results.map(async (page) => {\n        const props = page.properties;\n        const pageId = page.id;\n\n        // 모든 텍스트/제목 속성을 안전하게 추출하는 헬퍼\n        const getPlainText = (prop) => {\n          if (!prop) return \"\";\n          if (prop.title) return prop.title[0]?.plain_text || \"\";\n          if (prop.rich_text) return prop.rich_text[0]?.plain_text || \"\";\n          if (prop.select) return prop.select.name || \"\";\n          return \"\";\n        };\n\n        // 1. ID (Title 속성 찾기)\n        // 속성 이름이 'id'가 아니더라도 type이 'title'인 속성을 찾아 사용\n        const titleProp = Object.values(props).find((p) => p.type === \"title\");\n        const id = titleProp ? titleProp.title[0]?.plain_text || \"\" : \"\";\n\n        // 관계형 데이터(ExhibitionDetail) 조회 로직\n        let images = [];\n        // 'ExhibitionDetail' 또는 'Detail'이라는 이름의 Relation 속성을 찾음\n        const relationProp = props.ExhibitionDetail || props.Detail || Object.values(props).find(p => p.type === 'relation');\n\n        if (relationProp && relationProp.relation && relationProp.relation.length > 0) {\n          const relatedIds = relationProp.relation.map((r) => r.id);\n\n          // 연결된 상세 페이지들을 병렬로 조회\n          const relatedPages = await Promise.all(\n            relatedIds.map((id) => notion.pages.retrieve({ page_id: id }).catch(() => null))\n          );\n\n          // 유효한 페이지들에서 이미지 정보 추출\n          images = relatedPages\n            .filter((p) => p)\n            .map((p) => {\n              const pProps = p.properties;\n              \n              // 1. 파일/이미지 속성 찾기 ('image', 'file', 'File' 등 이름 불문하고 타입으로 검색)\n              const fileProp = Object.values(pProps).find(prop => prop.type === 'files');\n              const fileObj = fileProp?.files?.[0];\n              const link = fileObj?.file?.url || fileObj?.external?.url || \"\";\n\n              // 1. ID 찾기 (속성명 'id' 또는 'ID'인 Title 타입)\n              let idProp = pProps.id || pProps.ID || Object.values(pProps).find(prop => prop.type === 'title');\n              let idVal = idProp?.title?.[0]?.plain_text || \"\";\n\n              // 2. 제목(Title) 찾기 (속성명 'title' 또는 'Title'인 Rich Text 타입)\n              let titleProp = pProps.title || pProps.Title;\n              let titleVal = titleProp?.rich_text?.[0]?.plain_text || \"\";\n              \n              // 만약 title 속성을 못 찾았다면, id로 쓰인 Title 속성이 아닌 첫 번째 Rich Text를 제목으로 추정\n              if (!titleVal) {\n                 const fallbackProp = Object.values(pProps).find(prop => prop.type === 'rich_text' && prop !== titleProp);\n                 titleVal = fallbackProp?.rich_text?.[0]?.plain_text || \"\";\n              }\n\n              // 3. 메타 정보(Meta) 찾기 (속성명 'meta' 또는 'Meta'인 Rich Text 타입)\n              let metaProp = pProps.meta || pProps.Meta;\n              let metaVal = metaProp?.rich_text?.[0]?.plain_text || \"\";\n              \n              // 메타도 못 찾았다면, 제목으로 쓰지 않은 또 다른 Rich Text를 메타로 추정\n              if (!metaVal) {\n                 const fallbackMeta = Object.values(pProps).find(prop => prop.type === 'rich_text' && prop !== titleProp && prop !== metaProp);\n                 metaVal = fallbackMeta?.rich_text?.[0]?.plain_text || \"\";\n              }\n\n              return { id: idVal || p.id, title: titleVal, meta: metaVal, link };\n            })\n            // 이미지가 있는 항목만 필터링\n            .filter(item => item.link)\n            // ID(번호) 순으로 오름차순 정렬 (숫자 기준)\n            .sort((a, b) => a.id.localeCompare(b.id, undefined, { numeric: true }));\n        }\n\n        // console.log(`[Exhibition ${props.id?.title?.[0]?.plain_text}] Images:`, images.length);\n\n        return {\n          id: id,\n          year: getPlainText(props.year),\n          exhibitionTitle: getPlainText(props.exhibitionTitle),\n          date: getPlainText(props.date),\n          location: getPlainText(props.location),\n          description: getPlainText(props.description),\n          link: props.link?.url || \"\",\n          images, // 관계형 DB에서 가져온 이미지 리스트\n        };\n      })\n    );\n\n    localCache = data;\n    lastFetchTime = Date.now();\n    res.setHeader(\"Cache-Control\", \"s-maxage=300, stale-while-revalidate=600\");\n    res.status(200).json(data);\n  } catch (err) {\n    console.error(\"Exhibition API Error:\", err);\n    res.status(500).json({ error: \"Failed to load exhibitions\" });\n  }\n}"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,SAAS,IAAI,sMAAM,CAAC;IAAE,MAAM,QAAQ,GAAG,CAAC,YAAY;AAAC;AAE3D,IAAI,aAAa;AACjB,IAAI,gBAAgB;AACpB,MAAM,YAAY,OAAO,KAAK,GAAG,oBAAoB;AAEtC,eAAe,QAAQ,GAAG,EAAE,GAAG;IAC5C,MAAM,EAAE,KAAK,EAAE,GAAG,IAAI,KAAK;IAE3B,IAAI,UAAU,UAAU,cAAe,KAAK,GAAG,KAAK,gBAAgB,WAAY;QAC9E,IAAI,SAAS,CAAC,iBAAiB;QAC/B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;IAC9B;IAEA,IAAI;QACF,MAAM,aAAa,QAAQ,GAAG,CAAC,uBAAuB;QAEtD,MAAM,WAAW,MAAM,OAAO,SAAS,CAAC,KAAK,CAAC;YAC5C,aAAa;QACf;QAEA,MAAM,OAAO,MAAM,QAAQ,GAAG,CAC5B,SAAS,OAAO,CAAC,GAAG,CAAC,OAAO;YAC1B,MAAM,QAAQ,KAAK,UAAU;YAC7B,MAAM,SAAS,KAAK,EAAE;YAEtB,6BAA6B;YAC7B,MAAM,eAAe,CAAC;gBACpB,IAAI,CAAC,MAAM,OAAO;gBAClB,IAAI,KAAK,KAAK,EAAE,OAAO,KAAK,KAAK,CAAC,EAAE,EAAE,cAAc;gBACpD,IAAI,KAAK,SAAS,EAAE,OAAO,KAAK,SAAS,CAAC,EAAE,EAAE,cAAc;gBAC5D,IAAI,KAAK,MAAM,EAAE,OAAO,KAAK,MAAM,CAAC,IAAI,IAAI;gBAC5C,OAAO;YACT;YAEA,sBAAsB;YACtB,8CAA8C;YAC9C,MAAM,YAAY,OAAO,MAAM,CAAC,OAAO,IAAI,CAAC,CAAC,IAAM,EAAE,IAAI,KAAK;YAC9D,MAAM,KAAK,YAAY,UAAU,KAAK,CAAC,EAAE,EAAE,cAAc,KAAK;YAE9D,kCAAkC;YAClC,IAAI,SAAS,EAAE;YACf,wDAAwD;YACxD,MAAM,eAAe,MAAM,gBAAgB,IAAI,MAAM,MAAM,IAAI,OAAO,MAAM,CAAC,OAAO,IAAI,CAAC,CAAA,IAAK,EAAE,IAAI,KAAK;YAEzG,IAAI,gBAAgB,aAAa,QAAQ,IAAI,aAAa,QAAQ,CAAC,MAAM,GAAG,GAAG;gBAC7E,MAAM,aAAa,aAAa,QAAQ,CAAC,GAAG,CAAC,CAAC,IAAM,EAAE,EAAE;gBAExD,sBAAsB;gBACtB,MAAM,eAAe,MAAM,QAAQ,GAAG,CACpC,WAAW,GAAG,CAAC,CAAC,KAAO,OAAO,KAAK,CAAC,QAAQ,CAAC;wBAAE,SAAS;oBAAG,GAAG,KAAK,CAAC,IAAM;gBAG5E,uBAAuB;gBACvB,SAAS,aACN,MAAM,CAAC,CAAC,IAAM,GACd,GAAG,CAAC,CAAC;oBACJ,MAAM,SAAS,EAAE,UAAU;oBAE3B,8DAA8D;oBAC9D,MAAM,WAAW,OAAO,MAAM,CAAC,QAAQ,IAAI,CAAC,CAAA,OAAQ,KAAK,IAAI,KAAK;oBAClE,MAAM,UAAU,UAAU,OAAO,CAAC,EAAE;oBACpC,MAAM,OAAO,SAAS,MAAM,OAAO,SAAS,UAAU,OAAO;oBAE7D,wCAAwC;oBACxC,IAAI,SAAS,OAAO,EAAE,IAAI,OAAO,EAAE,IAAI,OAAO,MAAM,CAAC,QAAQ,IAAI,CAAC,CAAA,OAAQ,KAAK,IAAI,KAAK;oBACxF,IAAI,QAAQ,QAAQ,OAAO,CAAC,EAAE,EAAE,cAAc;oBAE9C,yDAAyD;oBACzD,IAAI,YAAY,OAAO,KAAK,IAAI,OAAO,KAAK;oBAC5C,IAAI,WAAW,WAAW,WAAW,CAAC,EAAE,EAAE,cAAc;oBAExD,mEAAmE;oBACnE,IAAI,CAAC,UAAU;wBACZ,MAAM,eAAe,OAAO,MAAM,CAAC,QAAQ,IAAI,CAAC,CAAA,OAAQ,KAAK,IAAI,KAAK,eAAe,SAAS;wBAC9F,WAAW,cAAc,WAAW,CAAC,EAAE,EAAE,cAAc;oBAC1D;oBAEA,yDAAyD;oBACzD,IAAI,WAAW,OAAO,IAAI,IAAI,OAAO,IAAI;oBACzC,IAAI,UAAU,UAAU,WAAW,CAAC,EAAE,EAAE,cAAc;oBAEtD,gDAAgD;oBAChD,IAAI,CAAC,SAAS;wBACX,MAAM,eAAe,OAAO,MAAM,CAAC,QAAQ,IAAI,CAAC,CAAA,OAAQ,KAAK,IAAI,KAAK,eAAe,SAAS,aAAa,SAAS;wBACpH,UAAU,cAAc,WAAW,CAAC,EAAE,EAAE,cAAc;oBACzD;oBAEA,OAAO;wBAAE,IAAI,SAAS,EAAE,EAAE;wBAAE,OAAO;wBAAU,MAAM;wBAAS;oBAAK;gBACnE,EACA,kBAAkB;iBACjB,MAAM,CAAC,CAAA,OAAQ,KAAK,IAAI,CACzB,6BAA6B;iBAC5B,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,EAAE,CAAC,aAAa,CAAC,EAAE,EAAE,EAAE,WAAW;wBAAE,SAAS;oBAAK;YACxE;YAEA,0FAA0F;YAE1F,OAAO;gBACL,IAAI;gBACJ,MAAM,aAAa,MAAM,IAAI;gBAC7B,iBAAiB,aAAa,MAAM,eAAe;gBACnD,MAAM,aAAa,MAAM,IAAI;gBAC7B,UAAU,aAAa,MAAM,QAAQ;gBACrC,aAAa,aAAa,MAAM,WAAW;gBAC3C,MAAM,MAAM,IAAI,EAAE,OAAO;gBACzB;YACF;QACF;QAGF,aAAa;QACb,gBAAgB,KAAK,GAAG;QACxB,IAAI,SAAS,CAAC,iBAAiB;QAC/B,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;IACvB,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,yBAAyB;QACvC,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA6B;IAC7D;AACF"}}]
}