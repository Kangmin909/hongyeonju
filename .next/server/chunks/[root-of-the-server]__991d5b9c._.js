module.exports=[70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},9823,e=>{"use strict";var t=e.i(26747),r=e.i(90406),o=e.i(44898),n=e.i(62950);new(e.i(61026)).Client({auth:process.env.NOTION_TOKEN});let a=process.env.OCI_PAR_URL;async function i(e,t){try{let r,o,n,i,s,l,d,p,u;if(console.log("ðŸ”¥ Webhook received!"),console.log("Body:",JSON.stringify(e.body,null,2)),"POST"!==e.method)return t.status(405).json({error:"Method Not Allowed"});let c=e.body?.data?.id,g=e.body?.data?.properties?.image?.files?.[0],f=g?.file?.url,m=g?.name;if(!c||!f||!m)return console.error("âŒ Missing required fields",{pageId:c,fileUrl:f,originalName:m}),t.status(400).json({error:"Invalid payload structure"});if(console.log("ðŸ“Œ Extracted pageId:",c),console.log("ðŸ“Œ Extracted fileUrl:",f),console.log("ðŸ“Œ Original filename:",m),!a)return console.error("âŒ PAR URL not found in env"),t.status(500).json({error:"Missing OCI_PAR_URL"});let h=m.split(".").pop().toLowerCase(),y=["png","jpg","jpeg","webp","gif"].includes(h),v=["mp4","mov","webm"].includes(h);if(!y&&!v)return console.error("âŒ Unsupported file type:",h),t.status(400).json({error:"Unsupported file type"});r=y?`image/${"jpg"===h?"jpeg":h}`:"video/mp4";let S=await fetch(f),w=await S.arrayBuffer(),R=Buffer.from(w),U=(o=new Date,i=(n=new Date(o.getTime()+324e5)).getUTCFullYear(),s=String(n.getUTCMonth()+1).padStart(2,"0"),l=String(n.getUTCDate()).padStart(2,"0"),d=String(n.getUTCHours()).padStart(2,"0"),p=String(n.getUTCMinutes()).padStart(2,"0"),u=String(n.getUTCSeconds()).padStart(2,"0"),`${i}${s}${l}T${d}${p}${u}`),$=m.lastIndexOf("."),x=-1!==$?m.substring(0,$):m,T=-1!==$?m.substring($):"",C=x.replace(/\s+/g,"_"),P=`${C}_${U}${T}`,b=`${a}${encodeURIComponent(P)}`;console.log("ðŸ“¤ Uploading via PAR:",b),console.log("ðŸ“„ Detected Content-Type:",r);let I=await fetch(b,{method:"PUT",headers:{"Content-Type":r},body:R});if(!I.ok){let e=await I.text();throw Error(`Upload failed: ${e}`)}console.log("âœ… File uploaded via PAR!");let E=b.split("?")[0];console.log("ðŸ”— Final OCI URL:",E);let O=await fetch(`https://api.notion.com/v1/pages/${c}`,{method:"PATCH",headers:{Authorization:`Bearer ${process.env.NOTION_TOKEN}`,"Content-Type":"application/json","Notion-Version":"2022-06-28"},body:JSON.stringify({properties:{link:{type:"url",url:E}}})}),j=await O.json();return console.log("ðŸ“ Notion Update Result:",j),t.status(200).json({ok:!0,pageId:c,type:y?"image":"video",uploadedUrl:E})}catch(e){return console.error("âŒ ERROR:",e),t.status(500).json({error:e.message})}}e.s(["default",()=>i],94671);var s=e.i(94671),l=e.i(7031),d=e.i(81927),p=e.i(46432);let u=(0,n.hoist)(s,"default"),c=(0,n.hoist)(s,"config"),g=new o.PagesAPIRouteModule({definition:{kind:r.RouteKind.PAGES_API,page:"/api/notionImageSync",pathname:"/api/notionImageSync",bundlePath:"",filename:""},userland:s,distDir:".next",relativeProjectDir:""});async function f(e,r,o){g.isDev&&(0,p.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/notionImageSync";n=n.replace(/\/index$/,"")||"/";let a=await g.prepare(e,r,{srcPage:n});if(!a){r.statusCode=400,r.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve());return}let{query:i,params:s,prerenderManifest:u,routerServerContext:c}=a;try{let t=e.method||"GET",o=(0,l.getTracer)(),a=o.getActiveScopeSpan(),p=g.instrumentationOnRequestError.bind(g),f=async a=>g.render(e,r,{query:{...i,...s},params:s,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:u.preview,propagateError:!1,dev:g.isDev,page:"/api/notionImageSync",internalRevalidate:null==c?void 0:c.revalidate,onError:(...t)=>p(e,...t)}).finally(()=>{if(!a)return;a.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let e=o.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=e.get("next.route");if(i){let e=`${t} ${i}`;a.setAttributes({"next.route":i,"http.route":i,"next.span_name":e}),a.updateName(e)}else a.updateName(`${t} ${n}`)});a?await f(a):await o.withPropagatedContext(e.headers,()=>o.trace(d.BaseServerSpan.handleRequest,{spanName:`${t} ${n}`,kind:l.SpanKind.SERVER,attributes:{"http.method":t,"http.target":e.url}},f))}catch(e){if(g.isDev)throw e;(0,t.sendError)(r,500,"Internal Server Error")}finally{null==o.waitUntil||o.waitUntil.call(o,Promise.resolve())}}e.s(["config",0,c,"default",0,u,"handler",()=>f],9823)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__991d5b9c._.js.map